CSDN地址：https://blog.csdn.net/sinat_27690807/article/details/110517732
又没审核过，但我准备慢慢搬，调格式真的要死人，SOS。

最近在做零信任相关软件的安装和调试，主要使用系统为linux的CentOS 7、Windows7和Win Server 2008 R2 64。

涉及到的软件为，Squid、OpenVPN、fwknop。
        
    所有使用软件已经上传至百度云。
    链接：https://pan.baidu.com/s/15pDpWjnWtTe5CIoic02Erg 提取码：q72t 
#1、设置实验环境

##1.1 安装虚拟机

本文涉及到的操作全部通过VMware Workstation15 Pro虚拟机完成，版本为15.5.7。

下载CentOS 7、Win7和Windows Server 2008 R2 x64安装.iso文件，CentOS 7作为服务端，Win7作为客户端，Windows Server 2008可视为内网服务器，CentOS 7和Win 7都需要安装VMware Tools辅助工具，方便传输文件。

首先安装虚拟机，然后分别安装三个所需虚拟机，每次安装记得修改虚拟光驱所存的.iso文件。

##1.2 配置网络环境

安装完成后，点击VMware的编辑按钮，选择虚拟机网络编辑器，修改VMnet1（仅主机模式）和VMnet8（NAT模式）网卡。

将VMnet1网卡的子网IP设置为192.168.0.0，子网掩码255.255.255.0，视作企业内网；将VMnet8的子网IP设置为172.16.0.0，子网掩码为255.255.0.0，视作互联网。

修改CentOS 7的设备信息，添加网络适配器2，两个适配器均选择自定义模式，适配器1网卡修改为VMnet1，适配器2网卡修改为VMnet8。
###1.2.1 Win Server

将Win Server 2008的网络适配器修改为VMnet1。

进入虚拟机，选中右下角网络连接按钮，右键进入网络和共享中心，修改本地连接属性中的的ipv4协议，将IP地址设置为192.168.0.10，子网掩码设置为255.255.255.0。

打开命令行，输入ipconfig查询IP地址修改是否成功。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201203100627288.png)

###1.2.2 Win 7

将Win7的网络适配器修改为VMnet8。

进入虚拟机，选中右下角网络连接按钮，右键进入网络和共享中心，修改本地连接属性中的的ipv4协议，将IP地址设置为172.16.10.10，子网掩码设置为255.255.0.0，默认网关172.16.0.2，DNS服务器172.16.0.2。

打开命令行，输入ipconfig查询IP地址修改是否成功。
……………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………
暂时先搬运openvpn的部分，让我的文章可以通过审核……
……………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………
## 2.2 Open***
### 2.2.1 配置vars文件
下载easy-rsa-old-master.zip压缩文件，该文件可以在Open***的Github库中直接找到，下载压缩文件即可，也存储在开头提供的百度云软件包中。

将压缩文件拖入CentOS 7虚拟机，解压。进入easy-rsa-old-master，再进入easy-rsa下属的2.0文件夹，通过修改vars配置文件，修改密钥默认配置信息。使用source命令使新配置生效。

执行./clean-all命令，新建keys文件夹。
```bash
root@localhost ~]# cd /home/xiahuai/easy-rsa-old-master
[root@localhost easy-rsa-old-master]# cd easy-rsa/2.0
[root@localhost 2.0]# ls
build-ca     build-key-pass    build-req-pass  openssl-0.9.6.cnf  revoke-full
build-dh     build-key-pkcs12  clean-all       openssl-0.9.8.cnf  sign-req
build-inter  build-key-server  inherit-inter   openssl-1.0.0.cnf  vars
build-key    build-req         list-crl        pkitool            whichopensslcnf
[root@localhost 2.0]# vim vars
[root@localhost 2.0]# source vars
NOTE: If you run ./clean-all, I will be doing a rm -rf on /home/xiahuai/easy-rsa-old-master/easy-rsa/2.0/keys
[root@localhost 2.0]# ll keys
ls: 无法访问keys: 没有那个文件或目录
[root@localhost 2.0]# ./clean-all
[root@localhost 2.0]# ll keys
总用量 4
-rw-r--r--. 1 root root 0 12月  4 09:33 index.txt
-rw-r--r--. 1 root root 3 12月  4 09:33 serial
```
### 2.2.2 生成根证书和密钥
生成根证书，可使用默认信息。
```bash
[root@localhost 2.0]# ./build-ca
```
在keys文件夹下生成根证书ca.crt和密钥ca.key。
```
[root@localhost 2.0]# ls keys
ca.crt  ca.key  index.txt  serial
```
### 2.2.3 生成服务端证书和密钥
生成服务端证书和密钥，需要两次确认。执行后，在keys文件夹下生成服务端证书server.crt和密钥server.key。
```bash
[root@localhost 2.0]# ./build-key-server server
Certificate is to be certified until Dec  2 01:49:36 2030 GMT (3650 days)
Sign the certificate? [y/n]:Y

1 out of 1 certificate requests certified, commit? [y/n]Y
Write out database with 1 new entries
Data Base Updated
[root@localhost 2.0]# ls keys
01.pem  ca.key     index.txt.attr  serial      server.crt  server.key
ca.crt  index.txt  index.txt.old   serial.old  server.csr
```
### 2.2.4 生成客户端证书和密钥
生成客户端证书和密钥，需要两次确认。执行后，在keys文件夹下生成服务端证书client.crt和密钥client.key。
```bash
[root@localhost 2.0]# ./build-key client
Certificate is to be certified until Dec  2 01:57:48 2030 GMT (3650 days)
Sign the certificate? [y/n]:Y

1 out of 1 certificate requests certified, commit? [y/n]Y
Write out database with 1 new entries
Data Base Updated
[root@localhost 2.0]# ls keys
01.pem  ca.crt  client.crt  client.key  index.txt.attr      index.txt.old  serial.old  server.csr
02.pem  ca.key  client.csr  index.txt   index.txt.attr.old  serial         server.crt  server.key
```
### 2.2.5 生成密钥交换文件
生成密钥交换文件
```bash
[root@localhost 2.0]# ./build-dh
[root@localhost 2.0]# ls keys/*.pem
keys/01.pem  keys/02.pem  keys/dh2048.pem
```
dh2048.pem就是所需的密钥交换文件。
### 2.2.6 配置运行Open***服务端
配置源并安装
```bash
[root@localhost 2.0]# cd /etc/yum.repos.d/
[root@localhost yum.repos.d]# yum clean all
[root@localhost yum.repos.d]# yum makecache
[root@localhost yum.repos.d]# yum -y install openvpn
```
复制粘贴所需证书和密钥文件
```bash
[root@localhost ~]# cd /etc/openvpn
[root@localhost openvpn]# ls 
client  server
[root@localhost openvpn]# cd /home/xiahuai/easy-rsa-old-master/easy-rsa/2.0/keys
[root@localhost keys]# cp {ca.crt,server.crt,server.key,dh2048.pem} /etc/openvpn/keys
```
回到配置文件所在目录
```bash
[root@localhost keys]# cd /etc/openvpn/keys
[root@localhost keys]# ls
ca.crt  dh2048.pem  server.crt  server.key
```
复制配置文件模板
```bash
t@localhost keys]# cd ..
[root@localhost openvpn]# cp /usr/share/doc/openvpn-2.4.9/sample/sample-config-files/server.conf ./
[root@localhost openvpn]# ls
client  keys  server  server.conf
```
使用vim server.conf命令，修改配置文件server.conf
```bash
## 修改内容
# 修改
ca keys/ca.crt
cert keys/server.crt
key keys/server.key  # This file should be kept secret

dh keys/dh2048.pem

tls-auth keys/ta.key 0 # This file is secret

cipher AES-256-GCM

server 10.0.1.0 255.255.255.0

# 添加
push "route 10.1.0.0 255.255.255.0"
push "route 192.168.0.0 255.255.255.0"
```
启用路由转发
```bash
[root@localhost openvpn]# echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
[root@localhost openvpn]# sysctl -p
net.ipv4.ip_forward = 1
```
配置ta.key
```bash
[root@localhost openvpn]# cd keys
[root@localhost keys]# openvpn --genkey --secret ta.key
[root@localhost keys]# ls
ca.crt  dh2048.pem  server.crt  server.key  ta.key
```
运行Open***
```bash
[root@localhost keys]# cd ..
[root@localhost openvpn]# openvpn --daemon --config server.conf
```
检查程序是否开启
```bash
[root@localhost openvpn]# netstat -lntup | grep 1194
udp        0      0 0.0.0.0:1194            0.0.0.0:*                           65655/openvpn    
```
### 2.2.7 配置Open***客户端
复制客户端配置文件模板，修改客户端配置文件client.conf
```bash
[root@localhost xiahuai]# cd easy-rsa-old-master
[root@localhost easy-rsa-old-master]# mkdir client
[root@localhost easy-rsa-old-master]# cp /usr/share/doc/openvpn-2.4.9/sample/sample-config-files/client.conf ./client
[root@localhost easy-rsa-old-master]# ls client
client.conf
[root@localhost easy-rsa-old-master]# cd client
[root@localhost client]# vim client.conf
```
配置文件修改内容如下：
```bash
# 修改为
;remote my-server-1 1194
;remote my-server-2 1194
remote 172.16.1.1 1194

cipher AES-256-GCM
```
修改客户端配置文件后缀名，并建立密钥和配置文件的压缩文件。
```bash
[root@localhost client]# mv client.conf client.ovpn
[root@localhost client]# ls
ca.crt client.crt client.key client.ovpn ta.key
[root@localhost client]# cd ..
[root@localhost easy-rsa-old-master]# zip client.zip client/*
  adding: client/ca.crt (deflated 31%)
  adding: client/client.crt (deflated 47%)
  adding: client/client.key (deflated 24%)
  adding: client/client.ovpn (deflated 54%)
  adding: client/ta.key (deflated 39%)
```
将CentOS 7虚拟机中的client.zip移动到Win 7虚拟机中。
从Open***官网下载安装程序，移动到Win 7虚拟机中（假如我记得写会一起放在百度云文件包里）。

由于程序运行需要安装.NET框架，首先确认Win7 虚拟机是否可以上网。点击Openvpn安装程序进行安装，安装设置选择默认，途中会安装.NET框架和TAP虚拟网卡，提示均选择确定。完成安装。
解压client.zip，将文件夹内所有文件转移到C:\Program Files\OpenVPN\config中。
图1
右键桌面Openvpn GUI程序，选择以管理员身份运行。选中右下角程序小图标，右键，点击选项-->高级，将配置文件地址和日志文件地址都改为C:\Program Files\OpenVPN\下属的对应config文件夹和log文件夹。
图2
打开Win 7的设备管理器，查看新添加的TAP-Windows Adapter V9虚拟网卡，发现由于数字签名不匹配，无法使用。

重启虚拟机，在开机界面按F8，打开启动菜单。选择禁用驱动程序签名强制选项，重启Win 7。
### 2.2.8 运行并测试网络连通性
重启后，运行Open***，右键桌面右下角程序小图标，选择连接。

<font color = grey size = 1>（这里我第一次运行的时候无法连接，一直提示TLS连接问题。
昨天同事也遇到了，说是firewalld防火墙的问题，在防火墙上开通1194端口后TLS连接问题消失。）

连接成功，提示连接到10.0.1.6客户端。

命令行中使用ipconfig命令查询网络连接状态：
图3
测试能否访问局域网接口
图4
测试能否访问局域网内Win Server服务器
图5
由于局域网内服务器内没有网关，因此无法返回对应数据包。

有两个解决方案：
1、给内网服务器添加网关，但为了安全性不建议。
2、配置iptables的nat功能。

回到CentOS虚拟机中，对iptables进行配置。

```bash
[root@localhost client]# iptables -t nat -A POSTROUTING -s 10.0.1.0/24 -j MASQUERADE
[root@localhost client]# iptables -L -t nat
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
MASQUERADE  all  --  10.0.1.0/24          anywhere            
```
新建立规则进行IP地址转换，不需要网关。

在Win7服务器上重新进行网络连通性测试，能够成功ping通局域网内Win Server服务器，成功连接。
图6
将Win Server虚拟机中对Zero-Trust文件夹共享设置进行修改，添加共享用户Everyone，权限读取。在Win 7服务器中访问\\192.168.0.10\，输入Administrator用户账号密码，访问Zero-Trust文件夹。
验证成功！
